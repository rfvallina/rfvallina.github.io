<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Raúl Fuente Vallina]]></title>
  <link href="http://rfvallina.com/atom.xml" rel="self"/>
  <link href="http://rfvallina.com/"/>
  <updated>2015-08-23T12:57:37+02:00</updated>
  <id>http://rfvallina.com/</id>
  <author>
    <name><![CDATA[Raúl Fuente Vallina]]></name>
    <email><![CDATA[raul@rfvallina.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Preview TIFF and PDF Files Using HTML5 File API]]></title>
    <link href="http://rfvallina.com/blog/2015/08/22/preview-tiff-and-pdf-files-using-html5-file-api/"/>
    <updated>2015-08-22T20:29:32+02:00</updated>
    <id>http://rfvallina.com/blog/2015/08/22/preview-tiff-and-pdf-files-using-html5-file-api</id>
    <content type="html"><![CDATA[<p>Sometimes you need to read files which are in the user&rsquo;s local machine. Here is where HTML <a href="http://www.w3.org/TR/FileAPI/"><strong>File API</strong></a> comes into play. The use case I&rsquo;m going to explain is when you want to make a preview of an image which has not been uploaded anywhere yet, so you don&rsquo;t have the url of the image.</p>

<!-- more -->


<p>Also, if the file is TIFF or PDF the thing complicates. But the good news is that the preview is also possible. All the examples below make use of jQuery library. If you are interested how, continue reading.</p>

<h3>Preview web standard images</h3>

<p>Below is the usual way of reading files using File API to make a preview of a standard <strong>JPG</strong> or <strong>PNG</strong> image.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;h2&gt;</span>Image Preview<span class="nt">&lt;/h2&gt;</span>
</span><span class='line'><span class="nt">&lt;label&gt;</span>Select a file (jpg, jpeg, png)<span class="nt">&lt;/label&gt;&lt;br/&gt;</span>
</span><span class='line'><span class="nt">&lt;div&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;file&quot;</span><span class="nt">/&gt;&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">fileTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">,</span> <span class="s1">&#39;png&#39;</span><span class="p">];</span>  <span class="c1">//acceptable file types</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;input:file&quot;</span><span class="p">).</span><span class="nx">change</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">parentEl</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">parent</span><span class="p">();</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">tgt</span> <span class="o">=</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">target</span> <span class="o">||</span> <span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">.</span><span class="nx">srcElement</span><span class="p">,</span>
</span><span class='line'>                      <span class="nx">files</span> <span class="o">=</span> <span class="nx">tgt</span><span class="p">.</span><span class="nx">files</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// FileReader support</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">FileReader</span> <span class="o">&amp;&amp;</span> <span class="nx">files</span> <span class="o">&amp;&amp;</span> <span class="nx">files</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">fr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">extension</span> <span class="o">=</span> <span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">fr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="nx">success</span> <span class="o">=</span> <span class="nx">fileTypes</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">extension</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>              <span class="k">if</span><span class="p">(</span><span class="nx">success</span><span class="p">)</span>
</span><span class='line'>                  <span class="nx">$</span><span class="p">(</span><span class="nx">parentEl</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;img src=&quot;&#39;</span> <span class="o">+</span> <span class="nx">fr</span><span class="p">.</span><span class="nx">result</span> <span class="o">+</span> <span class="s1">&#39;&quot; class=&quot;preview&quot;/&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="nx">fr</span><span class="p">.</span><span class="nx">onloadend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
</span><span class='line'>              <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Load End&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="nx">fr</span><span class="p">.</span><span class="nx">readAsDataURL</span><span class="p">(</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that first thing is to get the reference of the file/s on the change event. After that, we have to create an instance of <strong>FileReader</strong> to be able to read the file properly. Once we make sure that our browser supports FileReader and we have a reference to the file, then we read the file.</p>

<p>The outstanding aspect here is how we are reading the file with FileReader. Some methods are provided to read files. In this particular case we use <strong><em>FileReader.readAsDataURL(Blob|File)</em></strong> because the result property will contain the file/blob&rsquo;s data encoded as a data URL and that&rsquo;s what we are looking for in the <code>&lt;img&gt;</code> tag.</p>

<h3>Preview TIFF images</h3>

<p>Displaying a tiff image on the web has been always a nightmare. And still there&rsquo;s no standard way of achieving it. For our example we&rsquo;ll use  <a href="https://github.com/seikichi/tiff.js/tree/master"><strong>seikichi&rsquo;s tiff.js library</strong></a>.</p>

<p>Remember to add tiff js library.</p>

<p><code>&lt;script src="https://cdn.rawgit.com/seikichi/tiff.js/master/tiff.min.js"&gt;&lt;/script&gt;</code></p>

<p>Now, our fileTypes array will have support for tiff files only.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">fileTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tiff&#39;</span><span class="p">,</span> <span class="s1">&#39;tif&#39;</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>And, here is how we read and render tiff files.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">FileReader</span> <span class="o">&amp;&amp;</span> <span class="nx">files</span> <span class="o">&amp;&amp;</span> <span class="nx">files</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">fr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">extension</span> <span class="o">=</span> <span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">fr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">success</span> <span class="o">=</span> <span class="nx">fileTypes</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">extension</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="c1">//Using tiff.min.js library - https://github.com/seikichi/tiff.js/tree/master</span>
</span><span class='line'>          <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Parsing TIFF image...&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="c1">//initialize with 100MB for large files</span>
</span><span class='line'>          <span class="nx">Tiff</span><span class="p">.</span><span class="nx">initialize</span><span class="p">({</span>
</span><span class='line'>            <span class="nx">TOTAL_MEMORY</span><span class="o">:</span> <span class="mi">100000000</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">tiff</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Tiff</span><span class="p">({</span>
</span><span class='line'>            <span class="nx">buffer</span><span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">tiffCanvas</span> <span class="o">=</span> <span class="nx">tiff</span><span class="p">.</span><span class="nx">toCanvas</span><span class="p">();</span>
</span><span class='line'>          <span class="nx">$</span><span class="p">(</span><span class="nx">tiffCanvas</span><span class="p">).</span><span class="nx">css</span><span class="p">({</span>
</span><span class='line'>            <span class="s2">&quot;max-width&quot;</span><span class="o">:</span> <span class="s2">&quot;100px&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;width&quot;</span><span class="o">:</span> <span class="s2">&quot;100%&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;height&quot;</span><span class="o">:</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;display&quot;</span><span class="o">:</span> <span class="s2">&quot;block&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s2">&quot;padding-top&quot;</span><span class="o">:</span> <span class="s2">&quot;10px&quot;</span>
</span><span class='line'>          <span class="p">}).</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;preview&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="nx">$</span><span class="p">(</span><span class="nx">parentEl</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">tiffCanvas</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nx">fr</span><span class="p">.</span><span class="nx">onloadend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Load End&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nx">fr</span><span class="p">.</span><span class="nx">readAsArrayBuffer</span><span class="p">(</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The main difference here is now we are reading the file using <strong><em>FileReader.readAsArrayBuffer(Blob|File)</em></strong> and the image will be rendered on a HTML5 Canvas element.</p>

<h3>Preview PDF files</h3>

<p>Obviously, PDF files are not web compliant, so we have to make use of external libraries which help us deal with these type of files. A very well-known is the <a href="https://mozilla.github.io/pdf.js/"><strong>Mozilla PDF JS library</strong></a>. In our example we are going do a preview of the first page of the pdf file.</p>

<p>First, remember to include pdf js library in your html. You have to follow the steps described in the documentation to build the pdf.js project and generate the necessary pdf.js and pdf.worker.js files.</p>

<p>Now, our fileTypes array will have support for pdf files.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">fileTypes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pdf&#39;</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>Below is how we read the first page of a pdf file and render it on a HTML5 Canvas element.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">FileReader</span> <span class="o">&amp;&amp;</span> <span class="nx">files</span> <span class="o">&amp;&amp;</span> <span class="nx">files</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">fr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">extension</span> <span class="o">=</span> <span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">).</span><span class="nx">pop</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">fr</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">success</span> <span class="o">=</span> <span class="nx">fileTypes</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">extension</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">success</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Parsing PDF document...&quot;</span><span class="p">);</span>
</span><span class='line'>          <span class="c1">//PDFJS.workerSrc = &#39;&lt;path_to_pdf.worker.js&gt;&#39;;</span>
</span><span class='line'>          <span class="nx">PDFJS</span><span class="p">.</span><span class="nx">getDocument</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">result</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="nx">getPdf</span><span class="p">(</span><span class="nx">pdf</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">//</span>
</span><span class='line'>            <span class="c1">// Fetch the first page</span>
</span><span class='line'>            <span class="c1">//</span>
</span><span class='line'>            <span class="nx">pdf</span><span class="p">.</span><span class="nx">getPage</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="nx">getPage</span><span class="p">(</span><span class="nx">page</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>              <span class="kd">var</span> <span class="nx">scale</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">;</span>
</span><span class='line'>              <span class="kd">var</span> <span class="nx">viewport</span> <span class="o">=</span> <span class="nx">page</span><span class="p">.</span><span class="nx">getViewport</span><span class="p">(</span><span class="nx">scale</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>              <span class="c1">//</span>
</span><span class='line'>              <span class="c1">// Prepare canvas using PDF page dimensions</span>
</span><span class='line'>              <span class="c1">//</span>
</span><span class='line'>              <span class="nx">$</span><span class="p">(</span><span class="nx">parentEl</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;canvas id=&quot;pdf-image&quot; class=&quot;preview&quot;/&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>              <span class="kd">var</span> <span class="nx">canvas</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">parentEl</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;canvas.preview&quot;</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>              <span class="kd">var</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
</span><span class='line'>              <span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">viewport</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
</span><span class='line'>              <span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">viewport</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>              <span class="c1">//</span>
</span><span class='line'>              <span class="c1">// Render PDF page into canvas context</span>
</span><span class='line'>              <span class="c1">//</span>
</span><span class='line'>              <span class="kd">var</span> <span class="nx">renderContext</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">canvasContext</span><span class="o">:</span> <span class="nx">context</span><span class="p">,</span>
</span><span class='line'>                <span class="nx">viewport</span><span class="o">:</span> <span class="nx">viewport</span>
</span><span class='line'>              <span class="p">};</span>
</span><span class='line'>              <span class="nx">page</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">renderContext</span><span class="p">);</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>          <span class="p">});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nx">fr</span><span class="p">.</span><span class="nx">onloadend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;Load End&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nx">fr</span><span class="p">.</span><span class="nx">readAsArrayBuffer</span><span class="p">(</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can view or download the <a href="http://plnkr.co/edit/o7j0segKRpjJHwhh8WGO?p=preview"><strong>full example on this plunker</strong></a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Logging as a Service]]></title>
    <link href="http://rfvallina.com/blog/2015/06/19/logging-as-a-service/"/>
    <updated>2015-06-19T12:23:49+02:00</updated>
    <id>http://rfvallina.com/blog/2015/06/19/logging-as-a-service</id>
    <content type="html"><![CDATA[<p>Every software developer knows just how important it is to have a well-defined, well-functioning logging mechanism. Alas, we don’t always devote much effort to this task, thus missing on its many benefits, mainly error prevention and/or detection. If we look back in time, we readily observe that for Java the log4j library has been en vogue for a while now. Oftentimes, and until very recently, many apps were log4j-based and their log files were stored somewhere in the server. I have to admit that this could well be enough in some cases, provided the configuration is done competently and with a decent design.</p>

<!-- more -->


<p>However, things have been changing really rapidly, and now we have more attractive possibilities. The SaaS revolution has enabled what we call <strong>cloud logging</strong>, with the popularization of services such
as <a href="http://loggr.net/"><strong>loggr</strong></a>, <a href="https://papertrailapp.com/"><strong>papertrailapp</strong></a> or <a href="https://www.loggly.com/"><strong>loggly</strong></a>. Nowadays, even servers can be easily set up, using tools like <strong>syslogd</strong>, while <strong>Splunk</strong> can be relied on to analyze our data.</p>

<p><img class="center" src="http://rfvallina.com/images/blog/Logging_as_a_Service_Architectural_Model.jpg" width="450" height="269"></p>

<p>Thus, delegating app logging to a third party definitely offers many advantages. I have personally tested this technique with some of my apps, and cannot but recommend it. There are few cons, and many pros. Among the most important are:</p>

<ul>
<li>Developers only need to decide where in their apps they want to log info. No time allotted to design or to muse on issues such as logging paths, permissions and so on. Much time can be saved this way.</li>
<li>Being multi-platform systems, it pretty much doesn’t matter which programming language you are using. Your logging system remains the same, there’s no reason at all to change it, so you only need one client to connect and call the service.</li>
<li>Centralized logs. Imagine an arrangement where dozens or even hundreds of apps are working to fulfil a lot of different tasks; every log is centralized, so the administrator has its hands free to monitorize all the apps. Thumbs up.</li>
</ul>


<p><strong><em>And now, for the caveat</em></strong>: cloud logging requires, before you begin, the development of a client, which will be used for making calls to the service. This client can be very simple, using methods for making HTTP calls (UDP if you are going to use sylogd) and connecting to a service’s endpoint. Here I would advise you to develop a scalable client, which can work for any logging service; thus, if you happen to be unhappy with your provider, you will be able to make the change fairly easily.</p>

<p>I have developed a Java <strong>logging wrapper</strong> and made it available in <a href="https://github.com/rfvallina/log-wrapper">github</a>. It’s been implemented only for loggr.net and log4j, but it could be expanded for any other system. The big upside to using this kind of wrappers is that you can switch between several logging systems simply by changing one of the parameters in the configuration. Enjoy!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Validate Yahoo Signature With PHP]]></title>
    <link href="http://rfvallina.com/blog/2015/05/14/validate-yahoo-signature-with-php/"/>
    <updated>2015-05-14T12:53:20+02:00</updated>
    <id>http://rfvallina.com/blog/2015/05/14/validate-yahoo-signature-with-php</id>
    <content type="html"><![CDATA[<p>Yahoo allows applications to be integrated on Yahoo sites for merchants or simply Yahoo site owners. When you develop an application for Yahoo, first thing you have to do is to be able to validate the Yahoo signature to ensure all requests come from a Yahoo site.</p>

<!-- more -->


<p>The <a href="https://github.com/lexity/platform/wiki/API-Documentation">documentation</a> about developing an application for Yahoo is not really good but at least the section where it explains how to validate the signature comes with an example written in Ruby.</p>

<p>Below is the <strong>Ruby</strong> code to validate the Yahoo signature.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s2">&quot;digest/md5&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;cgi&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">signature</span><span class="p">(</span><span class="n">app_secret</span><span class="p">,</span> <span class="n">parameters</span><span class="p">)</span>
</span><span class='line'>  <span class="n">sorted_params</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">join</span>
</span><span class='line'>  <span class="no">Digest</span><span class="o">::</span><span class="no">MD5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">app_secret</span> <span class="o">+</span> <span class="n">sorted_params</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">valid_signature?</span><span class="p">(</span><span class="n">query_params</span><span class="p">)</span>
</span><span class='line'>  <span class="n">provided_signature</span> <span class="o">=</span> <span class="n">query_params</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;signature&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">query_params</span><span class="o">.</span><span class="n">each</span><span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">query_params</span><span class="o">[</span><span class="no">CGI</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">]</span> <span class="o">=</span> <span class="no">CGI</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">v</span><span class="p">)}</span>
</span><span class='line'>  <span class="n">provided_signature</span> <span class="o">==</span> <span class="n">signature</span><span class="p">(</span><span class="s2">&quot;sample_app_secret&quot;</span><span class="p">,</span> <span class="n">query_params</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Assume that the query parameters arrive in a hash (while still url-encoded), like:</span>
</span><span class='line'><span class="n">query_params</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'> <span class="s2">&quot;token&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;735c433875c919a4a7bc2b40e695b809&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="s2">&quot;app_token&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;sample_app_key&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="s2">&quot;store_url&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;http%3A%2F%2Fexample-store.com&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="s2">&quot;pid&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;a123b456&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="s2">&quot;timestamp&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;1346884490&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="s2">&quot;signature&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;3f1e8aba4426ff6f5d5bf579a4204e60&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here is the <strong>PHP</strong> code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='PHP'><span class='line'><span class="k">function</span> <span class="nf">validSignature</span><span class="p">(</span><span class="nv">$queryParams</span><span class="p">){</span>
</span><span class='line'>  <span class="nv">$providedSignature</span> <span class="o">=</span> <span class="nv">$queryParams</span><span class="p">[</span><span class="s1">&#39;signature&#39;</span><span class="p">];</span>
</span><span class='line'>  <span class="nb">unset</span><span class="p">(</span><span class="nv">$queryParams</span><span class="p">[</span><span class="s1">&#39;signature&#39;</span><span class="p">]);</span>
</span><span class='line'>  <span class="k">foreach</span><span class="p">(</span><span class="nv">$queryParams</span> <span class="k">as</span> <span class="nv">$key</span><span class="o">=&gt;</span><span class="nv">$value</span><span class="p">){</span>
</span><span class='line'>      <span class="nv">$queryParams</span><span class="p">[</span><span class="nb">urldecode</span><span class="p">(</span><span class="nv">$key</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">urldecode</span><span class="p">(</span><span class="nv">$value</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="nx">signature</span><span class="p">(</span><span class="s2">&quot;sample_app_secret&quot;</span><span class="p">,</span> <span class="nv">$queryParams</span><span class="p">)</span> <span class="o">===</span> <span class="nv">$providedSignature</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">function</span> <span class="nf">signature</span><span class="p">(</span><span class="nv">$appSecret</span><span class="p">,</span> <span class="nv">$queryParams</span><span class="p">){</span>
</span><span class='line'>  <span class="nv">$params</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
</span><span class='line'>  <span class="k">foreach</span><span class="p">(</span><span class="nv">$queryParams</span> <span class="k">as</span> <span class="nv">$key</span><span class="o">=&gt;</span><span class="nv">$value</span><span class="p">){</span>
</span><span class='line'>      <span class="nv">$params</span><span class="p">[]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">$key</span><span class="s2">=</span><span class="si">$value</span><span class="s2">&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nb">sort</span><span class="p">(</span><span class="nv">$params</span><span class="p">);</span>
</span><span class='line'>  <span class="nv">$sortedParams</span> <span class="o">=</span> <span class="nb">implode</span><span class="p">(</span><span class="nv">$params</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">md5</span><span class="p">(</span><span class="nv">$appSecret</span> <span class="o">.</span> <span class="nv">$sortedParams</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//Assume that the query parameters arrive in a hash (while still url-encoded), like:</span>
</span><span class='line'><span class="nv">$queryParams</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'> <span class="s2">&quot;token&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;735c433875c919a4a7bc2b40e695b809&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="s2">&quot;app_token&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;sample_app_key&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="s2">&quot;store_url&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;http%3A%2F%2Fexample-store.com&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="s2">&quot;pid&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;a123b456&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="s2">&quot;timestamp&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;1346884490&quot;</span><span class="p">,</span>
</span><span class='line'> <span class="s2">&quot;signature&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;3f1e8aba4426ff6f5d5bf579a4204e60&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Decide yourself which is more elegant, though I have my own opinion.</p>

<p>Here is a funny video which briefly explains some differences between PHP and Ruby.</p>

<iframe width="560" height="315" src="https://www.youtube.com/embed/g9CmE_miCaE" frameborder="0" allowfullscreen></iframe>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Deployment Management on Multiple AWS Instances With Capistrano 3]]></title>
    <link href="http://rfvallina.com/blog/2015/02/01/deployment-management-on-multiple-aws-instances-with-capistrano-3/"/>
    <updated>2015-02-01T16:02:16+01:00</updated>
    <id>http://rfvallina.com/blog/2015/02/01/deployment-management-on-multiple-aws-instances-with-capistrano-3</id>
    <content type="html"><![CDATA[<p>When your application has to run on multiple servers or you simply has multiple applications running on different servers it&rsquo;s always a good idea to automate this process so you don&rsquo;t have to manually deploy the application on each server every time a new fix, release or whatever is applied.</p>

<!-- more -->


<p>In my case, in the search of optimal results I have the same version of the application running on 3 different <strong>AWS EC2</strong> instances on different locations (Virginia, Oregon and California). You will understand what a nightmare this is when a new version of the application has to be deployed if you do this task manually.</p>

<p>So I considered doing a little research on how to improve this process by running one or a few commands to make all happen automatically. And this is what I found.</p>

<ul>
<li><strong>AWS OpsWorks</strong>: I never used it, but as far as I know it&rsquo;s highly customizable and useful for scaling up applications. Everything you can do with a script can be done with OpsWorks and there&rsquo;s no additional charge for using it. The drawback is what if you have an instance of the application running outside AWS environment. Then this is not your choice.</li>
<li><strong><a href="http://puppetlabs.com/">Puppet</a></strong>: I didn&rsquo;t test it but I saw it consists on a web tool and you can have your deployment configuration up and running very quickly and effortlessly. The drawback is that it&rsquo;s too expensive for a small business. Here is the <a href="http://puppetlabs.com/puppet/how-to-buy">pricing</a>.</li>
<li><strong>Jenkins</strong>: This is a powerful deployment management tool. I used it on Java projects mainly for <strong>CI</strong>. I always used it by installing it on the target server and with the aim of managing the deployments on that server only. It&rsquo;s open source.</li>
<li><strong><a href="http://capistranorb.com/">Capistrano</a></strong>: This is a Ruby tool whose purpose is to automate tasks on remote servers. Although it&rsquo;s perfect for our purpose, it can be good for other tasks like automate audits of any number of machines, script arbitrary workflows over SSH, automate common tasks in software teams,&hellip; It&rsquo;s fully customizable and it&rsquo;s open-source. So I decided to go with it to manage my deployments.</li>
</ul>


<h2>Installation</h2>

<p>First of all think about where your deployment management environment will be hosted. Personally I prefer to have the minimun possible configurations locally, so I decided to host it on my own virtual server (Linux CentOS 7). Below are the steps to install Capistrano 3 on Linux CentOS 7.</p>

<ul>
<li>Install Ruby (1.9+) if you haven&rsquo;t</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo yum install ruby
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Install Capistrano</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>gem install capistrano
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Create project folder</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>mkdir -p deployment/my-project
</span><span class='line'><span class="nb">cd </span>deployment/my-project
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Install capfile</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>cap install
</span></code></pre></td></tr></table></div></figure>


<p>This creates the following files:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>├── Capfile
</span><span class='line'>├── config
</span><span class='line'>│   ├── deploy
</span><span class='line'>│   │   ├── production.rb
</span><span class='line'>│   │   └── staging.rb
</span><span class='line'>│   └── deploy.rb
</span><span class='line'>└── lib
</span><span class='line'>    └── capistrano
</span><span class='line'>            └── tasks
</span></code></pre></td></tr></table></div></figure>


<h2>Usage</h2>

<ul>
<li>Set global variables on <strong>deploy.rb</strong></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">set</span> <span class="ss">:application</span><span class="p">,</span> <span class="s1">&#39;my-app-name&#39;</span>
</span><span class='line'><span class="c1"># set :repo_url, &#39;git@example.com:me/my_repo.git&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:repo_url</span><span class="p">,</span> <span class="s1">&#39;https://your-github-token@github.com/your-github-username/your-repo.git&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Default branch is :master</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span> <span class="s1">&#39;my-branch&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Note 1</strong>: I use token authentication method for Github. You can enable this on your github settings.
<strong>Note 2</strong>: If you don&rsquo;t set <strong>:deploy_to</strong> variable, the project is downloaded from github into <strong>/var/www/my_app_name</strong> with a specific structure:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">├──</span> <span class="n">current</span> <span class="o">-&gt;</span> <span class="sr">/var/</span><span class="n">www</span><span class="o">/</span><span class="n">my_app_name</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="mi">20150120114500</span><span class="o">/</span>
</span><span class='line'><span class="err">├──</span> <span class="n">releases</span>
</span><span class='line'><span class="err">│</span>   <span class="err">├──</span> <span class="mi">20150080072500</span>
</span><span class='line'><span class="err">│</span>   <span class="err">├──</span> <span class="mi">20150090083000</span>
</span><span class='line'><span class="err">│</span>   <span class="err">├──</span> <span class="mi">20150100093500</span>
</span><span class='line'><span class="err">│</span>   <span class="err">├──</span> <span class="mi">20150110104000</span>
</span><span class='line'><span class="err">│</span>   <span class="err">└──</span> <span class="mi">20150120114500</span>
</span><span class='line'><span class="err">├──</span> <span class="n">repo</span>
</span><span class='line'><span class="err">│</span>   <span class="err">└──</span> <span class="o">&lt;</span><span class="no">VCS</span> <span class="n">related</span> <span class="n">data</span><span class="o">&gt;</span>
</span><span class='line'><span class="err">├──</span> <span class="n">revisions</span><span class="o">.</span><span class="n">log</span>
</span><span class='line'><span class="err">└──</span> <span class="n">shared</span>
</span><span class='line'>    <span class="err">└──</span> <span class="o">&lt;</span><span class="n">linked_files</span> <span class="ow">and</span> <span class="n">linked_dirs</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Customize deployment tasks</li>
</ul>


<p>There are several hook tasks e.g. <strong>:started</strong>, <strong>:updated</strong> for you to hook up custom tasks into the flow using <strong>after()</strong> and <strong>before()</strong>. In my case I created my own tasks to copy specific files from the repository download folder to the application deployment folder.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">after</span> <span class="ss">:finished</span><span class="p">,</span> <span class="ss">:copy_files</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">target_dir</span> <span class="o">=</span> <span class="s2">&quot;/var/www/html/deploy&quot;</span>
</span><span class='line'>      <span class="n">target_dir_includes</span> <span class="o">=</span> <span class="n">target_dir</span> <span class="o">+</span> <span class="s2">&quot;/includes&quot;</span>
</span><span class='line'>      <span class="n">on</span> <span class="n">roles</span><span class="p">(</span><span class="ss">:virginia</span><span class="p">,</span> <span class="ss">:oregon</span><span class="p">,</span> <span class="ss">:california</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>          <span class="nb">print</span> <span class="s2">&quot;copying </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">#{</span><span class="n">target_dir</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="n">execute</span> <span class="s2">&quot;cp -rf </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/* </span><span class="si">#{</span><span class="n">target_dir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">on</span> <span class="n">roles</span><span class="p">(</span><span class="ss">:virginia</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>          <span class="nb">print</span> <span class="s2">&quot;copying </span><span class="si">#{</span><span class="n">target_dir_includes</span><span class="si">}</span><span class="s2">/db_config_virginia.php -&gt; </span><span class="si">#{</span><span class="n">target_dir_includes</span><span class="si">}</span><span class="s2">/db_config_data.php</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="n">execute</span> <span class="s2">&quot;cp -f </span><span class="si">#{</span><span class="n">target_dir_includes</span><span class="si">}</span><span class="s2">/db_config_virginia.php </span><span class="si">#{</span><span class="n">target_dir_includes</span><span class="si">}</span><span class="s2">/db_config_data.php&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">on</span> <span class="n">roles</span><span class="p">(</span><span class="ss">:oregon</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>          <span class="nb">print</span> <span class="s2">&quot;copying </span><span class="si">#{</span><span class="n">target_dir_includes</span><span class="si">}</span><span class="s2">/db_config_oregon.php -&gt; </span><span class="si">#{</span><span class="n">target_dir_includes</span><span class="si">}</span><span class="s2">/db_config_data.php</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="n">execute</span> <span class="s2">&quot;cp -f </span><span class="si">#{</span><span class="n">target_dir_includes</span><span class="si">}</span><span class="s2">/db_config_oregon.php </span><span class="si">#{</span><span class="n">target_dir_includes</span><span class="si">}</span><span class="s2">/db_config_data.php&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">on</span> <span class="n">roles</span><span class="p">(</span><span class="ss">:california</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>          <span class="nb">print</span> <span class="s2">&quot;copying </span><span class="si">#{</span><span class="n">target_dir_includes</span><span class="si">}</span><span class="s2">/db_config_california.php -&gt; </span><span class="si">#{</span><span class="n">target_dir_includes</span><span class="si">}</span><span class="s2">/db_config_data.php</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="n">execute</span> <span class="s2">&quot;cp -f </span><span class="si">#{</span><span class="n">target_dir_includes</span><span class="si">}</span><span class="s2">/db_config_california.php </span><span class="si">#{</span><span class="n">target_dir_includes</span><span class="si">}</span><span class="s2">/db_config_data.php&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that I have three roles (virginia, oregon and california) which correspond to the locations where the application is deployed. I make use of the roles concept to have different host and tasks per each.</p>

<p>Below is my <strong>production.rb</strong> file.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">role</span> <span class="ss">:virginia</span><span class="p">,</span> <span class="sx">%w{ec2-user@my-virginia-instance-domain.com}</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:oregon</span><span class="p">,</span> <span class="sx">%w{ec2-user@my-oregon-instance-domain.com}</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:california</span><span class="p">,</span> <span class="sx">%w{ec2-user@my-california-instance-domain.com}</span>
</span><span class='line'>
</span><span class='line'><span class="n">server</span> <span class="s1">&#39;my-virginia-instance-domain.com&#39;</span><span class="p">,</span>
</span><span class='line'><span class="ss">user</span><span class="p">:</span> <span class="s1">&#39;ec2-user&#39;</span><span class="p">,</span>
</span><span class='line'><span class="ss">roles</span><span class="p">:</span> <span class="sx">%w{virginia}</span><span class="p">,</span>
</span><span class='line'><span class="ss">ssh_options</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>     <span class="ss">user</span><span class="p">:</span> <span class="s1">&#39;ec2-user&#39;</span><span class="p">,</span> <span class="c1"># overrides user setting above</span>
</span><span class='line'>     <span class="ss">keys</span><span class="p">:</span> <span class="sx">%w(/path/to/virginia-file.pem)</span><span class="p">,</span>
</span><span class='line'>     <span class="ss">auth_methods</span><span class="p">:</span> <span class="sx">%w(publickey)</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">server</span> <span class="s1">&#39;my-oregon-instance-domain.com&#39;</span><span class="p">,</span>
</span><span class='line'><span class="ss">user</span><span class="p">:</span> <span class="s1">&#39;ec2-user&#39;</span><span class="p">,</span>
</span><span class='line'><span class="ss">roles</span><span class="p">:</span> <span class="sx">%w{oregon}</span><span class="p">,</span>
</span><span class='line'><span class="ss">ssh_options</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>     <span class="ss">user</span><span class="p">:</span> <span class="s1">&#39;ec2-user&#39;</span><span class="p">,</span> <span class="c1"># overrides user setting above</span>
</span><span class='line'>     <span class="ss">keys</span><span class="p">:</span> <span class="sx">%w(/path/to/oregon-file.pem)</span><span class="p">,</span>
</span><span class='line'>     <span class="ss">auth_methods</span><span class="p">:</span> <span class="sx">%w(publickey)</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">server</span> <span class="s1">&#39;ec2-user@my-california-instance-domain.com&#39;</span><span class="p">,</span>
</span><span class='line'><span class="ss">user</span><span class="p">:</span> <span class="s1">&#39;ec2-user&#39;</span><span class="p">,</span>
</span><span class='line'><span class="ss">roles</span><span class="p">:</span> <span class="sx">%w{california}</span><span class="p">,</span>
</span><span class='line'><span class="ss">ssh_options</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>     <span class="ss">user</span><span class="p">:</span> <span class="s1">&#39;ec2-user&#39;</span><span class="p">,</span> <span class="c1"># overrides user setting above</span>
</span><span class='line'>     <span class="ss">keys</span><span class="p">:</span> <span class="sx">%w(/path/to/california-file.pem)</span><span class="p">,</span>
</span><span class='line'>     <span class="ss">auth_methods</span><span class="p">:</span> <span class="sx">%w(publickey)</span>
</span><span class='line'>   <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that I&rsquo;m using &lsquo;publickey&rsquo; authentication method, so you need to tell capistrano the path to your private key (.pem file). For authentication you have to generate a public key and copy it to the remote servers. For more information about authentication on the remote servers, have a look at <a href="http://capistranorb.com/documentation/getting-started/authentication-and-authorisation/">capistrano reference guide</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Install Apache, PHP 5.5 and Memcached on AWS EC2]]></title>
    <link href="http://rfvallina.com/blog/2015/01/04/how-to-install-apache/"/>
    <updated>2015-01-04T00:00:00+01:00</updated>
    <id>http://rfvallina.com/blog/2015/01/04/how-to-install-apache</id>
    <content type="html"><![CDATA[<p>AWS EC2 looks like a good choice when you need a clean instance ready for you to manage your own server as per your needs.
Recently, I launched an EC2 instance from a Linux AMI (<strong>Amazon Linux AMI 2014.09.1</strong>) to create my own web server with <strong>Apache</strong> and support for <strong>PHP 5.5</strong>. I know Amazon has the <a href="http://aws.amazon.com/elasticbeanstalk/?nc2=h_ls">EB (Elastic Beanstalk)</a> service which comes with the necessary stuff already installed to run your Java, Node, PHP,&hellip; applications so that you only need to upload your code to the server and EB will do the rest.</p>

<!-- more -->


<p>I have experience dealing with AWS EB in the past and the reason this time I chose EC2 instead of EB is that with EC2 you have total freedom to set up your server. For instance, I found difficulties setting up cron jobs on EB in the past, but with EC2 this is a simple administration task when you connect to the server through ssh.</p>

<p><strong>What were the reasons that led me to choose AWS instead of a different hosting provider?</strong></p>

<p>This is a typical question when you are looking for the best and cheapest hosting provider for your applications. My reasons here were two: scalability and location.</p>

<ul>
<li><strong>Scalability</strong>: With AWS is easy to scale up your applications in a timely manner and with very low effort.</li>
<li><strong>Location</strong>: With AWS you can choose where to run your applications among different locations available all over the world or even replicate your application in different locations at the same time. The latter is what I wanted.</li>
</ul>


<p>Below are the steps to configure your EC2 instance based on a Linux AMI to run <strong>Apache Web Server</strong>, <strong>PHP 5.5</strong>, <strong>Memcached server</strong> and <strong>memcache extension</strong>. The sources I gathered information from were basically the <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/install-LAMP.html">AWS guid to install a LAMP server</a> and other forums around.</p>

<ul>
<li>Connect to your instance using ssh. Make sure you have previously downloaded and securely stored your private key and the ssh service enabled in your security group</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>ssh -i <span class="s2">&quot;/path/to/private_key.pem&quot;</span> ec2-user@your-public-dns-name
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Update instance packages</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo yum update -y
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Install <strong>Apache 2.4</strong>, <strong>PHP 5.5</strong> and <strong>PDO</strong> support for MySQL</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo yum install php55 php55-pdo php55-mysqlnd
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Start Apache and add httpd service to automatically start after a system boot.</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo service httpd start
</span><span class='line'>sudo chkconfig httpd on
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Connect to your Apache server. Make sure you have previously added <strong>port 80</strong> to your security group in the EC2 Console. Open a browser and type the following.</li>
</ul>


<p><a href="http://your-public-dns-name.com/">http://your-public-dns-name.com/</a></p>

<p>You will see the web server welcome page.</p>

<ul>
<li>Create www group, add ec2-user to the group and exit the terminal for the changes to take effect</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo groupadd www
</span><span class='line'>sudo usermod -a -G www ec2-user
</span><span class='line'><span class="nb">exit</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Give www ownership and add permission to the document root (/var/www)</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo chown -R root:www /var/www
</span><span class='line'>sudo chmod <span class="m">2775</span> /var/www
</span><span class='line'>find /var/www -type d -exec sudo chmod <span class="m">2775</span> <span class="o">{}</span> +
</span><span class='line'>find /var/www -type f -exec sudo chmod <span class="m">0664</span> <span class="o">{}</span> +
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Test PHP with the <strong>phpinfo</strong> page</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">echo</span> <span class="s2">&quot;&lt;?php phpinfo(); ?&gt;&quot;</span> &gt; /var/www/html/phpinfo.php
</span></code></pre></td></tr></table></div></figure>


<p>See the page by typing the url in a browser:</p>

<p><a href="http://your-public-dns-name.com/phpinfo.php">http://your-public-dns-name.com/phpinfo.php</a></p>

<ul>
<li>MySQL</li>
</ul>


<p>I didn&rsquo;t install MySQL on the EC2 instance itself, but I used the <a href="http://aws.amazon.com/rds/?nc2=h_ls">AWS RDS service</a>, so that all instances of my application can share only one database instance.</p>

<ul>
<li>Install <strong>memcached server</strong> and add it to the system boot. By default it will be listening on localhost and port 11211</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo yum install memcached
</span><span class='line'>sudo service memcached start
</span><span class='line'>sudo chkconfig --level <span class="m">345</span> memcached on
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Install <strong>memcache extension</strong></li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo yum install php55-pecl-memcache
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Welcome]]></title>
    <link href="http://rfvallina.com/blog/2014/12/25/welcome/"/>
    <updated>2014-12-25T20:58:39+01:00</updated>
    <id>http://rfvallina.com/blog/2014/12/25/welcome</id>
    <content type="html"><![CDATA[<p>Hi there! Welcome to my new site. From now on I&rsquo;ll be writing about technological matters on a regular basis. Subjects will be related to my personal experiences at work, IT research and of course interesting matters from the point of view of a freelancer.</p>

<p>Enjoy!</p>

<p><img class="center" src="http://rfvallina.com/images/blog/welcome.jpg" width="200" height="219"></p>
]]></content>
  </entry>
  
</feed>
